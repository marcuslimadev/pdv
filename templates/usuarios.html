{% extends "base.html" %}

{% block title %}Usuários - PDV System{% endblock %}

{% block content %}
<div class="mb-4">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1><i class="bi bi-people"></i> Gerenciamento de Usuários</h1>
            <p class="text-muted">Criar e gerenciar usuários do sistema</p>
        </div>
        <button class="btn btn-success btn-lg" onclick="novoUsuario()">
            <i class="bi bi-person-plus"></i> Novo Usuário
        </button>
    </div>
</div>

<!-- Tabela de Usuários -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Nome Completo</th>
                        <th>Tipo</th>
                        <th>Status</th>
                        <th>Criado em</th>
                        <th width="150">Ações</th>
                    </tr>
                </thead>
                <tbody id="usuarios-tbody">
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Novo/Editar Usuário -->
<div class="modal fade" id="modalUsuario" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalUsuarioTitle">Novo Usuário</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formUsuario">
                    <input type="hidden" id="usuario-id">
                    
                    <div class="mb-3">
                        <label for="username" class="form-label">Username *</label>
                        <input type="text" class="form-control" id="username" required>
                        <small class="form-text text-muted">Usado para login</small>
                    </div>

                    <div class="mb-3">
                        <label for="nome-completo" class="form-label">Nome Completo *</label>
                        <input type="text" class="form-control" id="nome-completo" required>
                    </div>

                    <div class="mb-3">
                        <label for="senha" class="form-label">Senha <span id="senha-opcional" style="display:none;">(deixe em branco para manter)</span></label>
                        <input type="password" class="form-control" id="senha">
                        <small class="form-text text-muted">Mínimo 4 caracteres</small>
                    </div>

                    <div class="mb-3">
                        <label for="tipo" class="form-label">Tipo de Usuário *</label>
                        <select class="form-select" id="tipo" required>
                            <option value="operador">Operador - Acesso ao PDV</option>
                            <option value="admin">Administrador - Acesso total</option>
                        </select>
                    </div>

                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="ativo" checked>
                        <label class="form-check-label" for="ativo">
                            Usuário ativo
                        </label>
                    </div>

                    <div class="alert alert-success" id="usuario-success" style="display: none;">
                        <i class="bi bi-check-circle"></i> <span id="usuario-success-msg"></span>
                    </div>
                    <div class="alert alert-danger" id="usuario-error" style="display: none;">
                        <i class="bi bi-exclamation-triangle"></i> <span id="usuario-error-msg"></span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" onclick="salvarUsuario()">
                    <i class="bi bi-save"></i> Salvar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let usuarios = [];
    let modalUsuario = null;

    // Carrega usuários
    function carregarUsuarios() {
        fetch('/api/usuarios')
            .then(response => response.json())
            .then(data => {
                usuarios = data;
                renderizarUsuarios();
            })
            .catch(error => {
                console.error('Erro ao carregar usuários:', error);
            });
    }

    // Renderiza tabela
    function renderizarUsuarios() {
        const tbody = document.getElementById('usuarios-tbody');
        
        if (usuarios.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        <i class="bi bi-inbox" style="font-size: 48px;"></i>
                        <p class="mt-3">Nenhum usuário cadastrado</p>
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = usuarios.map(u => `
            <tr>
                <td>${u.id}</td>
                <td><strong>${u.username}</strong></td>
                <td>${u.nome_completo}</td>
                <td>
                    ${u.tipo === 'admin' 
                        ? '<span class="badge bg-danger"><i class="bi bi-shield-check"></i> Administrador</span>' 
                        : '<span class="badge bg-primary"><i class="bi bi-person"></i> Operador</span>'}
                </td>
                <td>
                    ${u.ativo 
                        ? '<span class="badge bg-success">Ativo</span>' 
                        : '<span class="badge bg-secondary">Inativo</span>'}
                </td>
                <td>${u.criado_em ? new Date(u.criado_em).toLocaleDateString('pt-BR') : '-'}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="editarUsuario(${u.id})">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="desativarUsuario(${u.id})" 
                            ${!u.ativo ? 'disabled' : ''}>
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    // Novo usuário
    function novoUsuario() {
        document.getElementById('modalUsuarioTitle').textContent = 'Novo Usuário';
        document.getElementById('formUsuario').reset();
        document.getElementById('usuario-id').value = '';
        document.getElementById('username').disabled = false;
        document.getElementById('senha').required = true;
        document.getElementById('senha-opcional').style.display = 'none';
        document.getElementById('usuario-success').style.display = 'none';
        document.getElementById('usuario-error').style.display = 'none';
        document.getElementById('ativo').checked = true;
        
        modalUsuario = new bootstrap.Modal(document.getElementById('modalUsuario'));
        modalUsuario.show();
    }

    // Editar usuário
    function editarUsuario(id) {
        fetch(`/api/usuarios/${id}`)
            .then(response => response.json())
            .then(usuario => {
                document.getElementById('modalUsuarioTitle').textContent = 'Editar Usuário';
                document.getElementById('usuario-id').value = usuario.id;
                document.getElementById('username').value = usuario.username;
                document.getElementById('username').disabled = true;
                document.getElementById('nome-completo').value = usuario.nome_completo;
                document.getElementById('senha').value = '';
                document.getElementById('senha').required = false;
                document.getElementById('senha-opcional').style.display = 'inline';
                document.getElementById('tipo').value = usuario.tipo;
                document.getElementById('ativo').checked = usuario.ativo;
                document.getElementById('usuario-success').style.display = 'none';
                document.getElementById('usuario-error').style.display = 'none';
                
                modalUsuario = new bootstrap.Modal(document.getElementById('modalUsuario'));
                modalUsuario.show();
            })
            .catch(error => {
                alert('Erro ao carregar usuário');
                console.error(error);
            });
    }

    // Salvar usuário
    function salvarUsuario() {
        const id = document.getElementById('usuario-id').value;
        const username = document.getElementById('username').value.trim();
        const nomeCompleto = document.getElementById('nome-completo').value.trim();
        const senha = document.getElementById('senha').value;
        const tipo = document.getElementById('tipo').value;
        const ativo = document.getElementById('ativo').checked;

        // Validações
        if (!username || !nomeCompleto || !tipo) {
            document.getElementById('usuario-error-msg').textContent = 'Preencha todos os campos obrigatórios';
            document.getElementById('usuario-error').style.display = 'block';
            document.getElementById('usuario-success').style.display = 'none';
            return;
        }

        if (!id && !senha) {
            document.getElementById('usuario-error-msg').textContent = 'Senha é obrigatória para novos usuários';
            document.getElementById('usuario-error').style.display = 'block';
            document.getElementById('usuario-success').style.display = 'none';
            return;
        }

        if (senha && senha.length < 4) {
            document.getElementById('usuario-error-msg').textContent = 'Senha deve ter no mínimo 4 caracteres';
            document.getElementById('usuario-error').style.display = 'block';
            document.getElementById('usuario-success').style.display = 'none';
            return;
        }

        const dados = {
            username: username,
            nome_completo: nomeCompleto,
            tipo: tipo,
            ativo: ativo
        };

        if (senha) {
            dados.senha = senha;
        }

        const url = id ? `/api/usuarios/${id}` : '/api/usuarios';
        const method = id ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(dados)
        })
        .then(response => response.json())
        .then(data => {
            if (data.sucesso) {
                document.getElementById('usuario-success-msg').textContent = 
                    id ? 'Usuário atualizado com sucesso!' : 'Usuário criado com sucesso!';
                document.getElementById('usuario-success').style.display = 'block';
                document.getElementById('usuario-error').style.display = 'none';
                
                setTimeout(() => {
                    modalUsuario.hide();
                    carregarUsuarios();
                }, 1500);
            } else {
                document.getElementById('usuario-error-msg').textContent = data.erro || 'Erro ao salvar usuário';
                document.getElementById('usuario-error').style.display = 'block';
                document.getElementById('usuario-success').style.display = 'none';
            }
        })
        .catch(error => {
            document.getElementById('usuario-error-msg').textContent = 'Erro de comunicação com o servidor';
            document.getElementById('usuario-error').style.display = 'block';
            document.getElementById('usuario-success').style.display = 'none';
            console.error('Erro:', error);
        });
    }

    // Desativar usuário
    function desativarUsuario(id) {
        if (!confirm('Deseja realmente desativar este usuário?')) {
            return;
        }

        fetch(`/api/usuarios/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.sucesso) {
                carregarUsuarios();
            } else {
                alert(data.erro || 'Erro ao desativar usuário');
            }
        })
        .catch(error => {
            alert('Erro ao desativar usuário');
            console.error(error);
        });
    }

    // Inicializa
    carregarUsuarios();
</script>
{% endblock %}
